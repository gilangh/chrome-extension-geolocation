<!DOCTYPE html>
	<head>
		<link rel="stylesheet" href="/css/main.css"/>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script>
			var input_fields = ['street', 'zip', 'city'];

			var marker;
			var map;

			var defaultLatLng = new google.maps.LatLng(40.979898,-5.625);

			init = function() {
				document.getElementById('headline').innerText = chrome.i18n.getMessage('headline');
				document.getElementById('label_street').innerText = chrome.i18n.getMessage('street') + ':';
				document.getElementById('street').placeholder = chrome.i18n.getMessage('street');
				document.getElementById('label_zip').innerText = chrome.i18n.getMessage('zip') + ':';
				document.getElementById('zip').placeholder = chrome.i18n.getMessage('zip');
				document.getElementById('label_city').innerText = chrome.i18n.getMessage('city') + ':';
				document.getElementById('city').placeholder = chrome.i18n.getMessage('city');
				document.getElementById('label_country').innerText = chrome.i18n.getMessage('country') + ':';
				document.getElementById('button_geocoding').value = chrome.i18n.getMessage('geocoding');
				document.getElementById('label_latitude').innerText = chrome.i18n.getMessage('latitude') + ':';
				document.getElementById('label_longitude').innerText = chrome.i18n.getMessage('longitude') + ':';
				document.getElementById('label_woeid').innerText = chrome.i18n.getMessage('woeid') + ':';
				document.getElementById('latitude').style.width = String(chrome.i18n.getMessage('latitude_longitude_woeid_width')) + 'px';
				document.getElementById('longitude').style.width = String(chrome.i18n.getMessage('latitude_longitude_woeid_width')) + 'px';
				document.getElementById('woeid').style.width = String(chrome.i18n.getMessage('latitude_longitude_woeid_width')) + 'px';
				document.getElementById('copy_latitude').value = chrome.i18n.getMessage('copy');
				document.getElementById('copy_longitude').value = chrome.i18n.getMessage('copy');
				document.getElementById('copy_woeid').value = chrome.i18n.getMessage('copy');
				
				for (var i = 0; i < input_fields.length; i++) {
					document.getElementById(input_fields[i]).addEventListener('keyup', function(event) {
						window.localStorage.setItem('current_'+this.id, this.value);
						if (event.keyCode != 13) {
							window.localStorage.setItem('current_geocoding', 0);
						}
					}, false);
				}

				createMap();

				restoreLastStatus();

				delete init;
			}

			openLink = function(url) {
				switch (window.localStorage.getItem('link_target')) {
					case null:
					case undefined:
					case 'new_tab':
						chrome.tabs.create({'url': url});
						break;
					case 'active_tab':
						chrome.windows.getCurrent(function(w) {
							wid = w.id;
							chrome.tabs.getSelected(wid, function(t) {
								tid = t.id;
								chrome.tabs.update(tid, {'url': url});
							});
						});
						break;
					case 'new_window':
						chrome.windows.create({'url': url});
						break;
				}

				window.close();
			}

			restoreLastStatus = function() {
				for (var i = 0; i < input_fields.length; i++) {
					var value = window.localStorage.getItem('current_'+input_fields[i]);
					switch (value) {
						case null:
						case undefined:
							value = '';
							break;
					}
					document.getElementById(input_fields[i]).value = value;
				}

				if (window.localStorage.getItem('current_geocoding') == 1) {
					geocoding();
				}
			}

			showError = function(type) {
				with (document) {
					getElementById('copy_latitude').setAttribute('disabled', 'disabled');
					getElementById('copy_longitude').setAttribute('disabled', 'disabled');
					getElementById('copy_woeid').setAttribute('disabled', 'disabled');
					getElementById('view_larger_map').style.display = 'none';
					getElementById('view_larger_map').innerHTML = '';
					getElementById('error').innerText = chrome.i18n.getMessage(type);
					getElementById('error').style.backgroundImage = 'url(/images/'+type+'.png)';
					getElementById('error').style.display = 'block';
				}
			}

			clearError = function() {
				document.getElementById('error').style.display = 'none';
				document.getElementById('error').innerText = '';
			}

			geocoding = function() {
				window.localStorage.setItem('current_geocoding', 1);

				var street = document.getElementById('street').value;
				var zip = document.getElementById('zip').value;
				var city = document.getElementById('city').value;
				var country = document.getElementById('country').value;

				document.getElementById('latitude').value = '';
				document.getElementById('longitude').value = '';
				document.getElementById('woeid').value = '';

				if (street != '' || zip != '' || city != '' || country != '') {
					var url_google = 'http://maps.googleapis.com/maps/api/geocode/json?address='+String(encodeURIComponent(street))+',+'+String(encodeURIComponent(zip))+'+'+String(encodeURIComponent(city))+',+'+String(encodeURIComponent(country))+'&sensor=false';

					var xhr_google = new XMLHttpRequest();
					xhr_google.open('GET', url_google, true);
					xhr_google.onreadystatechange = function() {
						if (xhr_google.readyState == 4) {
							var response_google = JSON.parse(xhr_google.responseText);
							switch(response_google.status) {
								case 'OK':
									clearError();

									document.getElementById('latitude').value = response_google.results[0].geometry.location.lat;
									document.getElementById('copy_latitude').removeAttribute('disabled');
									document.getElementById('longitude').value = response_google.results[0].geometry.location.lng;
									document.getElementById('copy_longitude').removeAttribute('disabled');

									/* ---------- GET WOEID ---------- */
										var url_yahoo = 'http://query.yahooapis.com/v1/public/yql?q=select%20woeid%20from%20geo.placefinder%20where%20text%3D%22'+String(encodeURIComponent(street))+',%20'+String(encodeURIComponent(zip))+'%20'+String(encodeURIComponent(city))+',%20'+String(encodeURIComponent(country))+'%22&format=json';
										var xhr_yahoo = new XMLHttpRequest();
										xhr_yahoo.open('GET', url_yahoo, true);
										xhr_yahoo.onreadystatechange = function() {
											if (xhr_yahoo.readyState == 4) {
												var response_yahoo = JSON.parse(xhr_yahoo.responseText);
												if (response_yahoo.query.results.Result.woeid != undefined) {
													document.getElementById('woeid').value = response_yahoo.query.results.Result.woeid;
													document.getElementById('copy_woeid').removeAttribute('disabled');
												}
											}
										}
										xhr_yahoo.send();
									/* ---------- /GET WOEID ---------- */

									document.getElementById('view_larger_map').style.display = 'block';
									document.getElementById('view_larger_map').innerHTML = '<a href="javascript:openLink(\'http://maps.google.de/maps?q='+String(document.getElementById('latitude').value)+'+'+String(document.getElementById('longitude').value)+'\')">'+chrome.i18n.getMessage('view_larger_map')+'</a>';

									removeMarker();
									addMarker();

									break;
								case 'ZERO_RESULTS':
									showError('no_results');
									break;
								case 'OVER_QUERY_LIMIT':
									showError('over_quota');
									break;
							}
						}
					}
					xhr_google.send();
				}
			}

			copyValue = function(id) {
				document.getElementById(id).select();
				document.execCommand('Copy');
				window.getSelection().removeAllRanges();
			}

			createMap = function() {
				var myOptions = {
					zoom: 1,
					center: defaultLatLng,
					streetViewControl: false,
					mapTypeControl: true,
					mapTypeControlOptions: {
						style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
					},
					zoomControl: true,
					zoomControlOptions: {
						style: google.maps.ZoomControlStyle.SMALL
					},
					mapTypeId: google.maps.MapTypeId.ROADMAP
				}
				map = new google.maps.Map(document.getElementById('map'), myOptions);
			}

			resetMap = function() {
				removeMarker();
				map.setZoom(1);
				map.setCenter(defaultLatLng);
			}

			addMarker = function() {
				var latitude = document.getElementById('latitude').value;
				var longitude = document.getElementById('longitude').value;

				var myLatlng = new google.maps.LatLng(latitude, longitude);

				map.setZoom(13);
				map.setCenter(myLatlng);

				marker = new google.maps.Marker({
					position: myLatlng, 
					map: map,
					animation: google.maps.Animation.DROP,
					title: document.getElementById('street').value + '\r' + document.getElementById('zip').value + ' ' + document.getElementById('city').value
				});
			}

			removeMarker = function() {
				if (marker != undefined) {
					marker.setMap(null);
				}
			}
		</script>
	</head>
	<body id="page_popup" onload="init()">
		<h1 id="headline"></h1>
		<div id="left">
			<div id="left_top">
				<form id="address" onsubmit="geocoding(); return false;">
					<p>
						<label for="street" id="label_street"></label>
						<input type="text" id="street"/>
					</p>
					<p>
						<label for="zip" id="label_zip"></label>
						<input type="text" id="zip"/>
					</p>
					<p>
						<label for="city" id="label_city"></label>
						<input type="text" id="city"/>
					</p>
					<p>
						<label for="country" id="label_country"></label>
						<select id="country"></select>
					</p>
					<p>
						<label>&nbsp;</label>
						<input type="submit" id="button_geocoding"/>
					</p>
				</form>
				<div id="error"></div>
			</div>
			<div id="left_bottom">
				<form id="geodata">
					<p>
						<label for="latitude" id="label_latitude"></label>
						<input type="text" id="latitude" readonly="readonly"/>
						<input type="button" id="copy_latitude" onclick="copyValue('latitude')" disabled="disabled"/>
					</p>
					<p>
						<label for="longitude" id="label_longitude"></label>
						<input type="text" id="longitude" readonly="readonly"/>
						<input type="button" id="copy_longitude" onclick="copyValue('longitude')" disabled="disabled"/>
					</p>
					<p>
						<label for="woid" id="label_woeid"></label>
						<input type="text" id="woeid" readonly="readonly"/>
						<input type="button" id="copy_woeid" onclick="copyValue('woeid')" disabled="disabled"/>
					</p>
				</form>
			</div>
		</div>
		<div id="right">
			<div id="map"></div>
			<div id="view_larger_map"></div>
		</div>
		<div class="cb"></div>
	</body>
</html>