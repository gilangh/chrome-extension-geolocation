<!DOCTYPE html>
	<head>
		<link rel="stylesheet" href="/css/main.css"/>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script>
			var input_fields = ['street', 'zip', 'city'];
			
			init = function() {
				document.getElementById('headline').innerText = chrome.i18n.getMessage('headline');
				document.getElementById('label_street').innerText = chrome.i18n.getMessage('street') + ':';
				document.getElementById('street').placeholder = chrome.i18n.getMessage('street');
				document.getElementById('label_zip').innerText = chrome.i18n.getMessage('zip') + ':';
				document.getElementById('zip').placeholder = chrome.i18n.getMessage('zip');
				document.getElementById('label_city').innerText = chrome.i18n.getMessage('city') + ':';
				document.getElementById('city').placeholder = chrome.i18n.getMessage('city');
				document.getElementById('button_geocoding').value = chrome.i18n.getMessage('geocoding');
				document.getElementById('label_latitude').innerText = chrome.i18n.getMessage('latitude') + ':';
				document.getElementById('label_longitude').innerText = chrome.i18n.getMessage('longitude') + ':';
				document.getElementById('latitude').style.width = String(chrome.i18n.getMessage('latitude_longitude_width')) + 'px';
				document.getElementById('longitude').style.width = String(chrome.i18n.getMessage('latitude_longitude_width')) + 'px';
				document.getElementById('copy_latitude').value = chrome.i18n.getMessage('copy');
				document.getElementById('copy_longitude').value = chrome.i18n.getMessage('copy');
				
				for (var i = 0; i < input_fields.length; i++) {
					document.getElementById(input_fields[i]).addEventListener('keyup', function(event) {
						window.localStorage.setItem('current_'+this.id, this.value);
						if (event.keyCode != 13) {
							window.localStorage.setItem('current_geocoding', 0);
						}
					}, false);
				}

				restoreLastStatus();

				delete init;
			}

			openLink = function(url) {
				switch (window.localStorage.getItem('link_target')) {
					case null:
					case undefined:
					case 'new_tab':
						chrome.tabs.create({'url': url});
						break;
					case 'active_tab':
						chrome.windows.getCurrent(function(w) {
							wid = w.id;
							chrome.tabs.getSelected(wid, function(t) {
								tid = t.id;
								chrome.tabs.update(tid, {'url': url});
							});
						});
						break;
					case 'new_window':
						chrome.windows.create({'url': url});
						break;
				}

				window.close();
			}

			restoreLastStatus = function() {
				for (var i = 0; i < input_fields.length; i++) {
					var value = window.localStorage.getItem('current_'+input_fields[i]);
					switch (value) {
						case null:
						case undefined:
							value = '';
							break;
					}
					document.getElementById(input_fields[i]).value = value;
				}

				if (window.localStorage.getItem('current_geocoding') == 1) {
					geocoding();
				}
			}

			geocoding = function() {
				window.localStorage.setItem('current_geocoding', 1);

				var street = document.getElementById('street').value;
				var zip = document.getElementById('zip').value;
				var city = document.getElementById('city').value;

				if (street != '' || zip != '' || city != '') {
					document.getElementById('latitude').value = '';
					document.getElementById('longitude').value = '';

					var url = 'http://maps.googleapis.com/maps/api/geocode/json?address='+String(encodeURIComponent(street))+',+'+String(encodeURIComponent(zip))+'+'+String(encodeURIComponent(city))+'&sensor=false';

					var xhr = new XMLHttpRequest();
					xhr.open('GET', url, true);
					xhr.onreadystatechange = function() {
						if (xhr.readyState == 4) {
							var response = JSON.parse(xhr.responseText);
							switch(response.status) {
								case 'OK':
									document.getElementById('geodata').style.display = 'block';
									document.getElementById('latitude').value = response.results[0].geometry.location.lat;
									document.getElementById('longitude').value = response.results[0].geometry.location.lng;
									break;
								case 'ZERO_RESULTS':
									document.getElementById('geodata').style.display = 'none';
									document.getElementById('error').innerText = chrome.i18n.getMessage('no_results');
									break;
								case 'OVER_QUERY_LIMIT':
									document.getElementById('geodata').style.display = 'none';
									document.getElementById('error').innerText = chrome.i18n.getMessage('over_quota');
									break;
								default:
									document.getElementById('geodata').style.display = 'none';
									document.getElementById('error').innerText = response.status;
									break;
							}
							showOnMap();
						}
					}
					xhr.send();
				}
			}

			copyValue = function(id) {
				document.getElementById(id).select();
				document.execCommand('Copy');
				window.getSelection().removeAllRanges();
			}

			showOnMap = function() {
				var latitude = document.getElementById('latitude').value;
				var longitude = document.getElementById('longitude').value;

				if (latitude != '' && longitude != '') {
					document.getElementById('error').style.display = 'none';
					document.getElementById('map').style.display = 'block';
					document.getElementById('view_larger_map').style.display = 'block';
					document.getElementById('view_larger_map').innerHTML = '<a href="javascript:openLink(\'http://maps.google.de/maps?q='+String(encodeURIComponent(document.getElementById('street').value))+',+'+String(encodeURIComponent(document.getElementById('zip').value))+'+'+String(encodeURIComponent(document.getElementById('city').value))+'\')">'+chrome.i18n.getMessage('view_larger_map')+'</a>';

					var myLatlng = new google.maps.LatLng(latitude, longitude);
					var myOptions = {
						zoom: 12,
						center: myLatlng,
						mapTypeControl: true,
						mapTypeControlOptions: {
							style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
						},
						zoomControl: true,
						zoomControlOptions: {
							style: google.maps.ZoomControlStyle.SMALL
						},
						mapTypeId: google.maps.MapTypeId.ROADMAP
					}
					var map = new google.maps.Map(document.getElementById('map'), myOptions);
					var marker = new google.maps.Marker({
						position: myLatlng, 
						map: map,
						title: document.getElementById('street').value + '\r' + document.getElementById('zip').value + ' ' + document.getElementById('city').value
					});
				} else {
					document.getElementById('error').style.display = 'block';
					document.getElementById('map').style.display = 'none';
					document.getElementById('view_larger_map').style.display = 'none';
					document.getElementById('view_larger_map').innerHTML = '';
				}
			}
		</script>
	</head>
	<body onload="init()">
		<h1 id="headline"></h1>
		<form id="address" onsubmit="geocoding(); return false;">
			<p>
				<label for="street" id="label_street"></label>
				<input type="text" id="street"/>
			</p>
			<p>
				<label for="zip" id="label_zip"></label>
				<input type="text" id="zip"/>
			</p>
			<p>
				<label for="city" id="label_city"></label>
				<input type="text" id="city"/>
			</p>
			<p>
				<label>&nbsp;</label>
				<input type="submit" id="button_geocoding"/>
			</p>
		</form>
		<form id="geodata">
			<p>
				<label for="street" id="label_latitude"></label>
				<input type="text" id="latitude" readonly="readonly"/>
				<input type="button" id="copy_latitude" onclick="copyValue('latitude');"/>
			</p>
			<p>
				<label for="zip" id="label_longitude"></label>
				<input type="text" id="longitude" readonly="readonly"/>
				<input type="button" id="copy_longitude" onclick="copyValue('longitude');"/>
			</p>
		</form>
		<div id="map"></div>
		<div id="view_larger_map"></div>
		<div id="error"></div>
	</body>
</html>