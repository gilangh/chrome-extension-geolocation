<!DOCTYPE html>
	<head>
		<link rel="stylesheet" href="/css/main.css"/>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script>
			init = function() {
				document.getElementById('headline').innerText = chrome.i18n.getMessage('headline');
				document.getElementById('street').focus();
				delete init;
			}

			openLink = function(url) {
				switch (window.localStorage.getItem('link_target')) {
					case undefined:
					case 'new_tab':
						chrome.tabs.create({'url': url});
						break;
					case 'active_tab':
						chrome.windows.getCurrent(function(w) {
							wid = w.id;
							chrome.tabs.getSelected(wid, function(t) {
								tid = t.id;
								chrome.tabs.update(tid, {'url': url});
							});
						});
						break;
					case 'new_window':
						chrome.windows.create({'url': url});
						break;
				}

				window.close();
			}

			geocoding = function() {
				document.getElementById('latitude').value = '';
				document.getElementById('longitude').value = '';

				var street = document.getElementById('street').value;
				var zip = document.getElementById('zip').value;
				var city = document.getElementById('city').value;

				var url = 'http://maps.googleapis.com/maps/api/geocode/json?address='+String(encodeURIComponent(street))+',+'+String(encodeURIComponent(zip))+'+'+String(encodeURIComponent(city))+'&sensor=false';

				var xhr = new XMLHttpRequest();
				xhr.open('GET', url, true);
				xhr.onreadystatechange = function() {
					if (xhr.readyState == 4) {
						var response = JSON.parse(xhr.responseText);
						switch(response.status) {
							case 'OK':
								document.getElementById('geodata').style.display = 'block';
								document.getElementById('latitude').value = response.results[0].geometry.location.lat;
								document.getElementById('longitude').value = response.results[0].geometry.location.lng;
								break;
							case 'ZERO_RESULTS':
								document.getElementById('geodata').style.display = 'none';
								document.getElementById('error').innerText = 'Fuer die von Ihnen angegebene Adresse konnten keine Geodaten ermittelt werden.';
								break;
							default:
								document.getElementById('error').innerText = response.status;
								break;
						}
						showOnMap();
					}
				}
				xhr.send();
			}

			showOnMap = function() {
				var latitude = document.getElementById('latitude').value;
				var longitude = document.getElementById('longitude').value;

				if (latitude != '' && longitude != '') {
					document.getElementById('error').style.display = 'none';
					document.getElementById('map').style.display = 'block';

					var myLatlng = new google.maps.LatLng(latitude, longitude);
					var myOptions = {
						zoom: 12,
						center: myLatlng,
						mapTypeControl: true,
						mapTypeControlOptions: {
							style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
						},
						zoomControl: true,
						zoomControlOptions: {
							style: google.maps.ZoomControlStyle.SMALL
						},
						mapTypeId: google.maps.MapTypeId.ROADMAP
					}
					var map = new google.maps.Map(document.getElementById('map'), myOptions);
					var marker = new google.maps.Marker({
						position: myLatlng, 
						map: map,
						title: document.getElementById('street').value + '\r' + document.getElementById('zip').value + ' ' + document.getElementById('city').value
					});
				} else {
					document.getElementById('error').style.display = 'block';
					document.getElementById('map').style.display = 'none';
				}
			}
		</script>
	</head>
	<body onload ="init()">
		<h1 id="headline"></h1>
		<form id="address" onsubmit="geocoding(); return false;">
			<p>
				<label for="street">Street:</label>
				<input type="text" id="street" value="Ernst-Reuter-Platz 8"/>
			</p>
			<p>
				<label for="zip">ZIP code:</label>
				<input type="text" id="zip" value="10587"/>
			</p>
			<p>
				<label for="city">City:</label>
				<input type="text" id="city" value="Berlin"/>
			</p>
			<p>
				<label>&nbsp;</label>
				<input type="submit" value="Geocoding"/>
			</p>
		</form>
		<form id="geodata">
			<p>
				<label for="street">Latitude:</label>
				<input type="text" id="latitude" readonly="readonly"/>
			</p>
			<p>
				<label for="zip">Longitude:</label>
				<input type="text" id="longitude" readonly="readonly"/>
			</p>
		</form>
		<div id="map">Größere Kartenansicht</div>
		<div id="error"></div>
	</body>
</html>